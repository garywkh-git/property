{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %} | Mortgage Calculator — Know Before You Buy{% endblock %}

{% block content %}

<head>
<style>
    
    :root {
        --primary-orange: #FF6B35;
        --orange-light: #FFA07A;
        --orange-lighter: #FFF3E0;
        --orange-dark: #E55A2B;
        --orange-gradient: linear-gradient(135deg, #FF6B35 0%, #FF8E53 100%);
        --orange-gradient-light: linear-gradient(135deg, rgba(255, 107, 53, 0.1) 0%, rgba(255, 142, 83, 0.1) 100%);
        --shadow-orange: 0 10px 30px rgba(255, 107, 53, 0.15);
        --shadow-card: 0 15px 35px rgba(0, 0, 0, 0.08);
    }

    /* Hero Section */
    .calculator-hero {
        {% comment %} background: var(--orange-gradient), 
        url('{% static "img/mortgage-bg.jpg" %}') center/cover no-repeat; {% endcomment %}
        color: var(--orange-dark);
        padding: 40px 0;
        position: relative;
        text-align: center;
    }

    .calculator-hero::before {
        content: '';
        position: absolute;
        padding: 40px 0;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(247, 211, 181, 0.4);
    }

    .hero-content {
        position: relative;
        z-index: 2;
    }

    .hero-title {
        font-size: 3.2rem;
        font-weight: 800;
        margin-bottom: 20px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        animation: fadeInDown 1s ease;
    }

    .hero-subtitle {
        font-size: 1.2rem;
        max-width: 800px;
        margin: 0 auto 30px;
        line-height: 1.6;
        opacity: 0.9;
        animation: fadeInUp 1s ease 0.3s both;
    }

    /* Breadcrumb */
    .custom-breadcrumb {
        background: white;
        border-radius: 10px;
        padding: 20px 30px;
        margin: -40px auto 40px;
        max-width: 1200px;
        box-shadow: var(--shadow-orange);
        border: 1px solid rgba(255, 107, 53, 0.1);
    }

    .custom-breadcrumb .breadcrumb {
        background: none;
        margin: 0;
        padding: 0;
    }

    .custom-breadcrumb .breadcrumb-item a {
        color: var(--primary-orange);
        text-decoration: none;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    .custom-breadcrumb .breadcrumb-item a:hover {
        color: var(--orange-dark);
        text-decoration: underline;
    }

    .custom-breadcrumb .breadcrumb-item.active {
        color: var(--orange-dark);
        font-weight: 700;
    }

    .breadcrumb-item + .breadcrumb-item::before {
        color: var(--orange-light);
        content: "›";
        font-size: 1.2rem;
    }

    /* Calculator Container */
    .calculator-container {
        background: white;
        border-radius: 20px;
        padding: 40px;
        box-shadow: var(--shadow-card);
        border: 1px solid rgba(255, 107, 53, 0.1);
        margin-bottom: 40px;
    }

    .calculator-header {
        text-align: center;
        margin-bottom: 40px;
    }

    .calculator-icon {
        width: 80px;
        height: 80px;
        background: var(--orange-gradient);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 20px;
    }

    .calculator-icon i {
        font-size: 36px;
        color: white;
    }

    .calculator-title {
        color: #333;
        font-size: 2.2rem;
        font-weight: 700;
        margin-bottom: 10px;
    }

    .calculator-description {
        color: #666;
        font-size: 1.1rem;
        max-width: 600px;
        margin: 0 auto;
    }

    /* Form Styling */
    .calculator-form {
        margin-bottom: 30px;
    }

    .form-section {
        background: var(--orange-gradient-light);
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 25px;
        border: 1px solid rgba(255, 107, 53, 0.1);
    }

    .form-section-title {
        color: var(--primary-orange);
        font-size: 1.3rem;
        font-weight: 700;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .form-section-title i {
        font-size: 1.2rem;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-label {
        display: block;
        margin-bottom: 8px;
        color: #444;
        font-weight: 600;
        font-size: 0.95rem;
    }

    .form-control {
        width: 100%;
        padding: 14px 16px;
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        font-size: 1rem;
        transition: all 0.3s ease;
        background: white;
    }

    .form-control:focus {
        outline: none;
        border-color: var(--primary-orange);
        box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
    }

    .input-with-icon {
        position: relative;
    }

    .input-icon {
        position: absolute;
        left: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--primary-orange);
    }

    .input-with-icon input {
        padding-left: 45px;
    }

    .slider-container {
        margin-top: 15px;
    }

    .slider-value {
        color: var(--primary-orange);
        font-weight: 600;
        font-size: 1.1rem;
    }

    input[type="range"] {
        width: 100%;
        height: 8px;
        border-radius: 4px;
        background: #e0e0e0;
        outline: none;
        -webkit-appearance: none;
    }

    input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 24px;
        height: 24px;
        background: var(--primary-orange);
        border-radius: 50%;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    input[type="range"]::-webkit-slider-thumb:hover {
        background: var(--orange-dark);
        transform: scale(1.1);
    }

    /* Calculate Button */
    .btn-calculate {
        background: var(--orange-gradient);
        color: white;
        border: none;
        padding: 18px 45px;
        font-size: 1.1rem;
        font-weight: 700;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
        width: 100%;
        margin-top: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        box-shadow: 0 4px 15px rgba(255, 107, 53, 0.3);
    }

    .btn-calculate:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(255, 107, 53, 0.4);
        background: var(--orange-gradient-light);
        color: var(--primary-orange);
    }

    /* Results Section */
    .results-section {
        margin-top: 40px;
        animation: fadeInUp 0.6s ease;
    }

    .results-header {
        text-align: center;
        margin-bottom: 30px;
    }

    .results-icon {
        width: 70px;
        height: 70px;
        background: var(--orange-gradient);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 15px;
    }

    .results-icon i {
        font-size: 30px;
        color: white;
    }

    .results-title {
        color: #333;
        font-size: 1.8rem;
        font-weight: 700;
        margin-bottom: 5px;
    }

    .results-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        margin-bottom: 40px;
    }

    .result-card {
        background: white;
        border-radius: 15px;
        padding: 25px;
        text-align: center;
        transition: all 0.3s ease;
        border: 1px solid rgba(255, 107, 53, 0.1);
        box-shadow: var(--shadow-card);
    }

    .result-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-orange);
    }

    .result-card.highlight {
        background: var(--orange-gradient);
        color: white;
    }

    .result-card.highlight .result-value {
        color: white;
    }

    .result-label {
        color: #666;
        font-size: 0.95rem;
        margin-bottom: 10px;
        font-weight: 600;
    }

    .result-value {
        color: var(--primary-orange);
        font-size: 2rem;
        font-weight: 800;
        line-height: 1.2;
    }

    .result-card.highlight .result-label {
        color: rgba(255, 255, 255, 0.9);
    }

    .result-note {
        color: #666;
        font-size: 0.85rem;
        margin-top: 8px;
        font-style: italic;
    }

    /* Chart Section */
    .chart-section {
        background: white;
        border-radius: 15px;
        padding: 30px;
        margin-top: 40px;
        border: 1px solid rgba(255, 107, 53, 0.1);
        box-shadow: var(--shadow-card);
    }

    .chart-title {
        color: #333;
        font-size: 1.4rem;
        font-weight: 700;
        margin-bottom: 20px;
        text-align: center;
    }

    .chart-container {
        position: relative;
        height: 400px;
        margin: 0 auto;
    }

    /* Tips Section */
    .tips-section {
        background: linear-gradient(135deg, #FFF9F5 0%, #FFF0E6 100%);
        border-radius: 20px;
        padding: 40px;
        margin-top: 40px;
        border: 1px solid rgba(255, 107, 53, 0.1);
    }

    .tips-title {
        color: var(--primary-orange);
        font-size: 1.6rem;
        font-weight: 700;
        margin-bottom: 25px;
        text-align: center;
    }

    .tips-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
    }

    .tip-card {
        background: white;
        border-radius: 15px;
        padding: 25px;
        transition: all 0.3s ease;
        border: 1px solid rgba(255, 107, 53, 0.1);
    }

    .tip-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-card);
    }

    .tip-icon {
        width: 60px;
        height: 60px;
        background: var(--orange-gradient-light);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 20px;
    }

    .tip-icon i {
        font-size: 24px;
        color: var(--primary-orange);
    }

    .tip-title {
        color: #333;
        font-size: 1.2rem;
        font-weight: 700;
        margin-bottom: 10px;
    }

    .tip-content {
        color: #666;
        font-size: 0.95rem;
        line-height: 1.6;
    }

    /* Animations */
    @keyframes fadeInDown {
        from {
            opacity: 0;
            transform: translateY(-30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .hero-title {
            font-size: 2.2rem;
        }
        
        .hero-subtitle {
            font-size: 1rem;
        }
        
        .custom-breadcrumb {
            margin: -20px 20px 40px;
            padding: 15px;
        }
        
        .calculator-container {
            padding: 25px;
        }
        
        .calculator-title {
            font-size: 1.8rem;
        }
        
        .results-grid {
            grid-template-columns: 1fr;
        }
        
        .chart-container {
            height: 300px;
        }
        
        .tips-grid {
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 576px) {
        .form-section {
            padding: 20px;
        }
        
        .result-card {
            padding: 20px;
        }
        
        .result-value {
            font-size: 1.6rem;
        }
    }
</style>

</head>

<!-- Hero Section -->
<section class="calculator-hero">
    <div class="container">
        <div class="hero-content">
            <h1 class="hero-title">Mortgage Calculator</h1>
            <p class="hero-subtitle">
                Plan your property purchase with confidence. Calculate your monthly payments, 
                total costs, and make informed decisions about your dream home.
            </p>
        </div>
    </div>
</section>

<!-- Breadcrumb -->
 <br>
 <br>
<div class="container">
    <div class="custom-breadcrumb">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="{% url 'pages:index' %}">
                        <i class="fas fa-home"></i> Home
                    </a>
                </li>
                <li class="breadcrumb-item active">Mortgage Calculator</li>
            </ol>
        </nav>
    </div>
</div>

<!-- Calculator Section -->
<div class="container py-5">
    <div class="calculator-container">
        <!-- Calculator Header -->
        <div class="calculator-header">
            <div class="calculator-icon">
                <i class="fas fa-calculator"></i>
            </div>
            <h1 class="calculator-title">Mortgage Calculator</h1>
            <p class="calculator-description">
                Enter your property details below to calculate your monthly mortgage payments, 
                total repayment amount, and interest costs.
            </p>
        </div>

        <!-- Calculator Form -->
        <form method="post" class="calculator-form">
            {% csrf_token %}
            
            <div class="form-section">
                <h3 class="form-section-title">
                    <i class="fas fa-home"></i> Property Details
                </h3>
                
                <div class="row g-3">
                    <!-- Property Price -->
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label" for="id_property_price">
                                <i class="fas fa-home"></i> Property Price (HKD)
                            </label>
                            <div class="input-with-icon">
                                <i class="fas fa-dollar-sign input-icon"></i>
                                <input type="number" 
                                       name="property_price" 
                                       id="id_property_price" 
                                       class="form-control"
                                       value="{{ form.property_price.value|default:'5000000' }}"
                                       min="10000"
                                       max="100000000"
                                       step="10000"
                                       required>
                            </div>
                            <div class="slider-container">
                                <input type="range" 
                                       id="propertyPriceSlider" 
                                       min="10000" 
                                       max="50000000" 
                                       step="10000" 
                                       value="{{ form.property_price.value|default:'5000000' }}"
                                       class="property-slider">
                                <div class="slider-value" id="propertyPriceValue">
                                    HKD {{ form.property_price.value|default:'5,000,000'|intcomma }}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Down Payment -->
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label" for="id_down_payment_percent">
                                <i class="fas fa-hand-holding-usd"></i> Down Payment (%)
                            </label>
                            <div class="input-with-icon">
                                <i class="fas fa-percent input-icon"></i>
                                <input type="number" 
                                       name="down_payment_percent" 
                                       id="id_down_payment_percent" 
                                       class="form-control downpayment-input"
                                       value="{{ form.down_payment_percent.value|default:'30' }}"
                                       min="10"
                                       max="90"
                                       step="5"
                                       required>
                            </div>
                            <div class="slider-container">
                                <input type="range" 
                                       id="downPaymentSlider" 
                                       min="10" 
                                       max="90" 
                                       step="5" 
                                       value="{{ form.down_payment_percent.value|default:'30' }}"
                                       class="downpayment-slider">
                                <div class="slider-value" id="downPaymentValue">
                                    {{ form.down_payment_percent.value|default:'30' }}%
                                </div>
                                <div class="result-note" id="downPaymentAmount">
                                    Amount: HKD {{ result.down_payment_amount|default:'1,500,000'|intcomma }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Loan Amount (Calculated) -->
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-money-bill-wave"></i> Loan Amount (Calculated)
                    </label>
                    <div class="input-with-icon">
                        <i class="fas fa-dollar-sign input-icon"></i>
                        <input type="number" 
                               name="principal" 
                               id="id_principal" 
                               class="form-control loan-amount-input"
                               value="{{ form.principal.value|default:'3500000' }}"
                               readonly
                               style="background-color: #f8f9fa;">
                    </div>
                    <div class="result-note">
                        This is automatically calculated based on Property Price and Down Payment
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h3 class="form-section-title">
                    <i class="fas fa-percentage"></i> Interest & Term
                </h3>
                
                <div class="row g-3">
                    <!-- Interest Rate -->
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label" for="id_annual_interest_rate">
                                <i class="fas fa-chart-line"></i> Annual Interest Rate (%)
                            </label>
                            <div class="input-with-icon">
                                <i class="fas fa-percent input-icon"></i>
                                <input type="number" 
                                       name="annual_interest_rate" 
                                       id="id_annual_interest_rate" 
                                       class="form-control"
                                       value="{{ form.annual_interest_rate.value|default:'3.5' }}"
                                       min="0.1"
                                       max="15"
                                       step="0.1"
                                       required>
                            </div>
                            <div class="slider-container">
                                <input type="range" 
                                       id="interestSlider" 
                                       min="1" 
                                       max="10" 
                                       step="0.1" 
                                       value="{{ form.annual_interest_rate.value|default:'3.5' }}">
                                <div class="slider-value" id="interestValue">
                                    {{ form.annual_interest_rate.value|default:'3.5' }}%
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Loan Term -->
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label" for="id_years">
                                <i class="fas fa-calendar-alt"></i> Loan Term (Years)
                            </label>
                            <div class="input-with-icon">
                                <i class="fas fa-clock input-icon"></i>
                                <input type="number" 
                                       name="years" 
                                       id="id_years" 
                                       class="form-control"
                                       value="{{ form.years.value|default:'25' }}"
                                       min="5"
                                       max="40"
                                       step="5"
                                       required>
                            </div>
                            <div class="slider-container">
                                <input type="range" 
                                       id="yearsSlider" 
                                       min="5" 
                                       max="40" 
                                       step="5" 
                                       value="{{ form.years.value|default:'25' }}">
                                <div class="slider-value" id="yearsValue">
                                    {{ form.years.value|default:'25' }} years
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Calculate Button -->
            <button type="submit" class="btn-calculate">
                <i class="fas fa-calculator"></i>
                Calculate Mortgage
            </button>
        </form>

        <!-- Results Section -->
        {% if result %}
        <div class="results-section">
            <div class="results-header">
                <div class="results-icon">
                    <i class="fas fa-chart-pie"></i>
                </div>
                <h2 class="results-title">Calculation Results</h2>
                <p class="calculator-description">
                    Based on your inputs, here's a breakdown of your mortgage details:
                </p>
            </div>

            <div class="results-grid">
                <!-- Property Price -->
                <div class="result-card">
                    <div class="result-label">Property Price</div>
                    <div class="result-value">HKD {{ result.property_price|intcomma }}</div>
                    <div class="result-note">Total purchase price</div>
                </div>

                <!-- Down Payment -->
                <div class="result-card">
                    <div class="result-label">Down Payment</div>
                    <div class="result-value">HKD {{ result.down_payment_amount|intcomma }}</div>
                    <div class="result-note">{{ result.down_payment_percent|default:'30' }}% of property price</div>
                </div>

                <!-- Loan Amount -->
                <div class="result-card">
                    <div class="result-label">Loan Amount</div>
                    <div class="result-value">HKD {{ result.loan_amount|intcomma }}</div>
                    <div class="result-note">Amount to be financed</div>
                </div>

                <!-- Monthly Payment -->
                <div class="result-card highlight">
                    <div class="result-label">Monthly Payment</div>
                    <div class="result-value">HKD {{ result.monthly_payment|intcomma }}</div>
                    <div class="result-note">Your estimated monthly mortgage payment</div>
                </div>

                <!-- Total Payment -->
                <div class="result-card">
                    <div class="result-label">Total Repayment</div>
                    <div class="result-value">HKD {{ result.total_payment|intcomma }}</div>
                    <div class="result-note">Total amount to be repaid over the loan term</div>
                </div>

                <!-- Total Interest -->
                <div class="result-card">
                    <div class="result-label">Total Interest</div>
                    <div class="result-value">HKD {{ result.total_interest|intcomma }}</div>
                    <div class="result-note">Interest paid over the loan term</div>
                </div>
            </div>

            <!-- Chart Section -->
            <div class="chart-section">
                <h3 class="chart-title">Payment Breakdown</h3>
                <div class="chart-container">
                    <canvas id="repaymentChart"></canvas>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Tips Section -->
    <div class="tips-section">
        <h2 class="tips-title">Mortgage Tips & Insights</h2>
        <div class="tips-grid">
            <!-- ... (keep existing tips content) ... -->
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Format numbers with commas
        function formatNumber(num) {
            if (!num && num !== 0) return "0";
            return parseFloat(num).toLocaleString('en-US', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            });
        }

        // Calculate loan amount based on property price and down payment
        function calculateLoanAmount() {
            const propertyPrice = parseFloat(document.getElementById('id_property_price').value) || 0;
            const downPaymentPercent = parseFloat(document.getElementById('id_down_payment_percent').value) || 0;
            
            const downPaymentAmount = propertyPrice * (downPaymentPercent / 100);
            const loanAmount = propertyPrice - downPaymentAmount;
            
            // Update loan amount input
            const loanInput = document.getElementById('id_principal');
            if (loanInput) {
                loanInput.value = Math.round(loanAmount);
            }
            
            // Update down payment amount display
            const downPaymentAmountElement = document.getElementById('downPaymentAmount');
            if (downPaymentAmountElement) {
                downPaymentAmountElement.textContent = 'Amount: HKD ' + formatNumber(Math.round(downPaymentAmount));
            }
            
            return {
                propertyPrice,
                downPaymentPercent,
                downPaymentAmount,
                loanAmount
            };
        }

        // Sync slider with input field and display
        function syncSlider(sliderId, inputId, displayId, isCurrency = false, isPercent = false) {
            const slider = document.getElementById(sliderId);
            const input = document.getElementById(inputId);
            const display = document.getElementById(displayId);
            
            if (!slider || !input || !display) {
                console.error('Could not find elements:', { sliderId, inputId, displayId });
                return;
            }
            
            // Function to update all elements
            function updateAll(value) {
                // Update slider
                slider.value = value;
                
                // Update input field
                input.value = value;
                
                // Update display
                if (isCurrency) {
                    display.textContent = 'HKD ' + formatNumber(value);
                } else if (isPercent) {
                    display.textContent = value + '%';
                } else if (sliderId === 'yearsSlider') {
                    display.textContent = value + ' years';
                } else {
                    display.textContent = value;
                }
                
                // Recalculate loan amount if property price or down payment changes
                if (sliderId === 'propertyPriceSlider' || sliderId === 'downPaymentSlider') {
                    calculateLoanAmount();
                }
            }
            
            // When slider changes
            slider.addEventListener('input', function() {
                updateAll(this.value);
            });
            
            // When input field changes
            input.addEventListener('input', function() {
                updateAll(this.value);
            });
            
            // Initial update
            updateAll(input.value || slider.value);
        }

        // Initialize all syncs
        syncSlider('propertyPriceSlider', 'id_property_price', 'propertyPriceValue', true, false);
        syncSlider('downPaymentSlider', 'id_down_payment_percent', 'downPaymentValue', false, true);
        syncSlider('interestSlider', 'id_annual_interest_rate', 'interestValue', false, true);
        syncSlider('yearsSlider', 'id_years', 'yearsValue', false, false);

        // Initialize loan amount calculation
        calculateLoanAmount();

        // Create chart if results exist
        {% if result %}
        const ctx = document.getElementById('repaymentChart');
        
        if (ctx) {
            // Data for the chart
            const downPayment = {{ result.down_payment_amount|default:1500000 }};
            const principal = {{ result.loan_amount|default:3500000 }};
            const interest = {{ result.total_interest|default:0 }};
            const totalCost = downPayment + principal + interest;
            
            const data = {
                labels: ['Down Payment', 'Principal', 'Interest'],
                datasets: [{
                    data: [downPayment, principal, interest],
                    backgroundColor: ['#4CAF50', '#FF6B35', '#FFA07A'],
                    borderColor: ['#FFF', '#FFF', '#FFF'],
                    borderWidth: 2,
                    hoverOffset: 15
                }]
            };
            
            // Create chart with improved tooltips
            const chart = new Chart(ctx, {
                type: 'doughnut',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                font: {
                                    size: 14,
                                    family: "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif"
                                },
                                generateLabels: function(chart) {
                                    const data = chart.data;
                                    if (data.labels.length && data.datasets.length) {
                                        return data.labels.map(function(label, i) {
                                            const value = data.datasets[0].data[i];
                                            const percentage = Math.round((value / totalCost) * 100);
                                            return {
                                                text: label + ': HKD ' + formatNumber(value) + ' (' + percentage + '%)',
                                                fillStyle: data.datasets[0].backgroundColor[i],
                                                strokeStyle: data.datasets[0].borderColor[i],
                                                lineWidth: data.datasets[0].borderWidth,
                                                hidden: isNaN(data.datasets[0].data[i]) || chart.getDatasetMeta(0).data[i].hidden,
                                                index: i
                                            };
                                        });
                                    }
                                    return [];
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    const value = context.raw;
                                    const percentage = Math.round((value / totalCost) * 100);
                                    label += 'HKD ' + formatNumber(value) + ' (' + percentage + '%)';
                                    return label;
                                }
                            }
                        }
                    },
                    cutout: '60%',
                    animation: {
                        animateScale: true,
                        animateRotate: true
                    }
                }
            });
            
            // Add a title to the chart showing total cost
            const chartTitle = document.createElement('div');
            chartTitle.className = 'chart-total-cost';
            chartTitle.style.textAlign = 'center';
            chartTitle.style.marginTop = '20px';
            chartTitle.style.fontWeight = 'bold';
            chartTitle.style.color = '#333';
            chartTitle.style.fontSize = '1.2rem';
            chartTitle.innerHTML = 'Total Cost: <span style="color: #FF6B35">HKD ' + formatNumber(totalCost) + '</span>';
            
            ctx.parentNode.appendChild(chartTitle);
        }
        {% endif %}

        // Add animation to result cards
        const resultCards = document.querySelectorAll('.result-card');
        resultCards.forEach((card, index) => {
            card.style.animationDelay = `${index * 0.1}s`;
        });
    });
</script>

{% endblock %}